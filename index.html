<script>
  // Global variables
  let currentData = { columns: [], rows: [] };
  let currentSQL = "";
  let currentDBFilename = ""; // ✨ Store the uploaded DB's unique filename

  // Upload SQLite database
  async function uploadDB() {
    const fileInput = document.getElementById("dbfile");
    const uploadStatus = document.getElementById("uploadStatus");

    if (!fileInput.files.length) {
      uploadStatus.innerHTML = '<span class="error-message">Please select a .db file</span>';
      return;
    }

    const formData = new FormData();
    formData.append("dbfile", fileInput.files[0]);

    try {
      uploadStatus.innerHTML = '<span>Uploading database...</span>';

      const res = await fetch("/upload_db", { method: "POST", body: formData });
      const data = await res.json();

      if (res.ok) {
        uploadStatus.innerHTML = '<span class="success-message">✓ Database uploaded successfully and indexed in Chroma!</span>';
        
        currentDBFilename = data.db_filename; // Store unique DB filename

        // Reset UI
        document.getElementById("sqlOutput").innerText = "";
        document.getElementById("resultsTable").innerHTML = "";
        document.getElementById("chart-container").classList.add("hidden");
        document.getElementById("visualizationControls").classList.add("hidden");

        document.getElementById("exportBtn").disabled = true;
        document.getElementById("visualizeBtn").disabled = true;

      } else {
        uploadStatus.innerHTML = `<span class="error-message">Error: ${data.error || "Unknown error"}</span>`;
      }

    } catch (error) {
      uploadStatus.innerHTML = `<span class="error-message">Error: ${error.message}</span>`;
    }
  }

  // Send natural language query to backend
  async function sendQuery() {
    const query = document.getElementById("query").value;

    if (!currentDBFilename) {
      alert("Please upload a database first.");
      return;
    }
    if (!query) {
      alert("Please enter a query");
      return;
    }

    try {
      const res = await fetch("/query", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
          query: query, 
          db_filename: currentDBFilename // ✨ Include db_filename
        })
      });

      const data = await res.json();

      if (!res.ok) {
        document.getElementById("sqlOutput").innerText = "Error: " + (data.error || "Unknown error");
        return;
      }

      // Store SQL and results
      currentSQL = data.sql;
      currentData = { columns: data.columns, rows: data.rows };

      document.getElementById("sqlOutput").innerText = currentSQL || "No SQL generated";

      // Enable export & visualize buttons if data exists
      const hasData = data.columns && data.rows.length;
      document.getElementById("exportBtn").disabled = !hasData;
      document.getElementById("visualizeBtn").disabled = !hasData;

      // Populate column dropdowns
      if (hasData) {
        const xColumn = document.getElementById("xColumn");
        const yColumn = document.getElementById("yColumn");
        xColumn.innerHTML = "";
        yColumn.innerHTML = "";
        data.columns.forEach(col => {
          xColumn.innerHTML += `<option value="${col}">${col}</option>`;
          yColumn.innerHTML += `<option value="${col}">${col}</option>`;
        });
      }

      // Hide charts
      document.getElementById("chart-container").classList.add("hidden");
      document.getElementById("visualizationControls").classList.add("hidden");

      // Render table
      populateResultsTableAndControls(data);

    } catch (error) {
      document.getElementById("sqlOutput").innerText = "Error: " + error.message;
    }
  }

  // Render table
  function populateResultsTableAndControls(data) {
    const table = document.getElementById("resultsTable");
    table.innerHTML = "";

    if (data.columns && data.rows) {
      const headerRow = document.createElement("tr");
      data.columns.forEach(col => {
        const th = document.createElement("th");
        th.innerText = col;
        headerRow.appendChild(th);
      });
      table.appendChild(headerRow);

      data.rows.forEach(row => {
        const tr = document.createElement("tr");
        row.forEach(cell => {
          const td = document.createElement("td");
          td.innerText = cell !== null ? cell : "NULL";
          tr.appendChild(td);
        });
        table.appendChild(tr);
      });
    }
  }

  // Show visualization controls
  function showVisualizationControls() {
    document.getElementById("visualizationControls").classList.remove("hidden");
  }

  // Generate visualization
  async function generateVisualization() {
    const chartType = document.getElementById("chartType").value;
    const xColumn = document.getElementById("xColumn").value;
    const yColumn = document.getElementById("yColumn").value;

    if (!xColumn || !yColumn) {
      alert("Please select both X and Y columns");
      return;
    }

    try {
      const res = await fetch("/visualize", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          sql: currentSQL,
          chart_type: chartType,
          x_column: xColumn,
          y_column: yColumn
        })
      });

      const data = await res.json();

      if (!res.ok) {
        alert("Visualization error: " + (data.error || "Unknown error"));
        return;
      }

      const chartContainer = document.getElementById("chart-container");
      chartContainer.innerHTML = `<img src="${data.chart_image}" alt="Data Visualization">`;
      chartContainer.classList.remove("hidden");

    } catch (error) {
      alert("Visualization error: " + error.message);
    }
  }

  // Export results to CSV
  async function exportToCSV() {
    if (!currentData.columns.length || !currentData.rows.length) {
      alert("No data to export");
      return;
    }

    try {
      const res = await fetch("/export_csv", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(currentData)
      });

      if (!res.ok) {
        const errorData = await res.json();
        alert("Export failed: " + (errorData.error || "Unknown error"));
        return;
      }

      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.style.display = "none";
      a.href = url;
      a.download = "query_results.csv";
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);

    } catch (error) {
      alert("Export error: " + error.message);
    }
  }
</script>
